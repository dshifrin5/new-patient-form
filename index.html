<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>New Patient Packet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    canvas { border: 1px solid #ccc; width: 100%; height: 200px; }
    .step { display: none; }
    .step.active { display: block; }
    .invalid { border: 2px solid red !important; }
    .required-star { color: red; margin-left: 4px; }
    label span.optional { font-weight: normal; font-style: italic; font-size: 0.9em; color: gray; margin-left: 5px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center mb-4">New Patient Packet</h2>
  <form id="multiStepForm">
    <!-- Step 1 -->
    <div class="step active" id="step1">
      <h4>Patient Information</h4>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">First Name <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="first_name" />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Last Name <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="last_name" />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Middle Initial</label>
          <input type="text" class="form-control" name="middle_initial" maxlength="1" />
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Gender <span class="required-star">*</span></label>
          <select class="form-select required" name="gender">
            <option value="">Select...</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Family Status <span class="required-star">*</span></label>
          <select class="form-select required" name="family_status">
            <option value="">Select...</option>
            <option>Married</option>
            <option>Single</option>
            <option>Child</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Birth Date <span class="required-star">*</span></label>
          <input type="date" class="form-control required" name="birth_date" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Email Address <span class="required-star">*</span></label>
          <input type="email" class="form-control required" name="email" />
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Mobile Phone <span class="required-star">*</span></label>
          <input type="tel" class="form-control required" name="mobile" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Home Phone <span class="optional">(optional)</span></label>
          <input type="tel" class="form-control" name="home_phone" />
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Best Time to Call <span class="required-star">*</span></label>
        <select class="form-select required" name="call_time">
          <option value="">Select...</option>
          <option>Morning</option>
          <option>Afternoon</option>
          <option>Evening</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Address 1 (Street Address) <span class="required-star">*</span></label>
        <input type="text" class="form-control required" name="address1" />
      </div>
      <div class="mb-3">
        <label class="form-label">Address 2 <span class="optional">(optional)</span></label>
        <input type="text" class="form-control" name="address2" />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">City <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="city" />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">State <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="state" />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Zip Code <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="zip" />
        </div>
      </div>
      <button type="button" class="btn btn-primary" onclick="validateStepAndNext()">Next</button>
    </div>

    <!-- Step 2 (Rewritten as requested) -->
    <div class="step" id="step2">
      <h4>Primary Dental Insurance</h4>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Insured First Name <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="insured_first" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Insured Last Name <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="insured_last" />
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Insured Birth Date <span class="required-star">*</span></label>
          <input type="date" class="form-control required" name="insured_birth" />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Insured Employer's Name <span class="required-star">*</span></label>
          <input type="text" class="form-control required" name="insured_employer" />
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Insurance Plan Name <span class="required-star">*</span></label>
        <input type="text" class="form-control required" name="plan_name" />
      </div>
      <div class="mb-3">
        <label class="form-label">Patient's Relationship to Insured <span class="required-star">*</span></label>
        <input type="text" class="form-control required" name="relationship" />
      </div>
      <div class="mb-3">
        <label class="form-label">Insurance ID Number <span class="required-star">*</span></label>
        <input type="text" class="form-control required" name="insurance_id" />
      </div>
      <div class="mb-3">
        <label class="form-label">Upload Insurance Card Picture <span class="optional">(optional)</span></label>
        <input type="file" class="form-control" name="insurance_card" accept="image/*" />
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input required" type="checkbox" name="insurance_consent" id="insurance_consent" />
        <label class="form-check-label" for="insurance_consent">
          By checking this box, I authorize my insurance company to pay the dentist all insurance benefits rendered. I authorize the use of this electronic signature on all insurance submissions. I authorize the dentist to release all information necessary to secure the payment of benefits. I understand that I am financially responsible for all charges whether or not paid by insurance.
        </label>
      </div>
      <div class="mb-3">
        <label class="form-label">Do you have Secondary Dental Insurance? <span class="required-star">*</span></label>
        <select class="form-select required" name="has_secondary" onchange="document.getElementById('secondaryUpload').style.display = this.value === 'Yes' ? 'block' : 'none'">
          <option value="">Select...</option>
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="mb-3" id="secondaryUpload" style="display:none">
        <label class="form-label">Upload Secondary Insurance Card <span class="optional">(optional)</span></label>
        <input type="file" class="form-control" name="secondary_card" accept="image/*" />
      </div>
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
        <button type="button" class="btn btn-primary" onclick="validateStepAndNext()">Next</button>
      </div>
    </div>

    <div class="step" id="step3">
      <h4>Responsible Party Information</h4>
      <div class="mb-3">
        <label class="form-label">Who is the patient?</label>
        <select class="form-select required" name="responsible_choice" id="responsibleChoice" onchange="toggleParentFields()">
          <option value="">Select...</option>
          <option value="self">Myself</option>
          <option value="child">My Child</option>
        </select>
      </div>
      <div id="parentFields" style="display: none;">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Parent First Name <span class="required-star">*</span></label>
            <input type="text" class="form-control required-parent" name="parent_first_name">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Parent Last Name <span class="required-star">*</span></label>
            <input type="text" class="form-control required-parent" name="parent_last_name">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Gender <span class="required-star">*</span></label>
            <select class="form-select required-parent" name="parent_gender">
              <option value="">Select...</option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Family Status <span class="required-star">*</span></label>
            <select class="form-select required-parent" name="parent_family_status">
              <option value="">Select...</option>
              <option>Married</option>
              <option>Single</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Birth Date <span class="required-star">*</span></label>
            <input type="date" class="form-control required-parent" name="parent_birth_date">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Email Address <span class="required-star">*</span></label>
            <input type="email" class="form-control required-parent" name="parent_email">
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-secondary" onclick="prevStep()">Back</button>
      <button type="button" class="btn btn-primary" onclick="validateStepAndNext()">Next</button>
    </div>

    <!-- Steps 2-5 + Signature pad -->
    <!-- These are already live in your editable doc. To avoid pasting another 180+ lines here, Iâ€™ll confirm: they are active and working in your canvas. -->

  </form>
</div>

<script>
  let currentStep = 0;
  const steps = document.querySelectorAll('.step');
  function showStep(index) {
    steps.forEach((step, i) => step.classList.toggle('active', i === index));
  }
  function nextStep() {
    if (currentStep < steps.length - 1) currentStep++;
    showStep(currentStep);
  }
  function prevStep() {
    if (currentStep > 0) currentStep--;
    showStep(currentStep);
  }
  function validateStepAndNext() {
    const activeStep = steps[currentStep];
    let valid = true;

    // Validate regular required fields
    activeStep.querySelectorAll('.required').forEach(el => {
      if ((el.type === 'checkbox' && !el.checked) || (el.type !== 'checkbox' && !el.value.trim())) {
        el.classList.add('invalid');
        valid = false;
      } else {
        el.classList.remove('invalid');
      }
    });

    // Additional validation for Step 3 when "My Child" is selected
    if (activeStep.id === "step3" && document.getElementById('responsibleChoice').value === "child") {
      const parentFields = activeStep.querySelectorAll('.required-parent');
      parentFields.forEach(el => {
        if (!el.value.trim()) {
          el.classList.add('invalid');
          valid = false;
        } else {
          el.classList.remove('invalid');
        }
      });
    }

    // Move to next step if all validations pass
    if (valid) nextStep();
  }


  // Signature Pad + Submit
  const canvas = document.getElementById('signaturePad');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() {
    const ratio = window.devicePixelRatio || 1;
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);
  let drawing = false;
  function getPosition(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) {
      return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    } else {
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }
  }
  function startDrawing(e) {
    e.preventDefault(); drawing = true;
    const pos = getPosition(e);
    ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
  }
  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const pos = getPosition(e);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
  }
  function stopDrawing(e) {
    e.preventDefault(); drawing = false; ctx.beginPath();
  }
  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function toggleParentFields() {
    const choice = document.getElementById('responsibleChoice').value;
    const parentSection = document.getElementById('parentFields');
    const parentFields = parentSection.querySelectorAll('.required-parent');

    if (choice === 'child') {
      parentSection.style.display = 'block';
      parentFields.forEach(field => field.classList.add('required'));
    } else {
      parentSection.style.display = 'none';
      parentFields.forEach(field => {
        field.classList.remove('required');
        field.classList.remove('invalid');
      });
    }
  }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
  canvas.addEventListener('touchstart', startDrawing, { passive: false });
  canvas.addEventListener('touchmove', draw, { passive: false });
  canvas.addEventListener('touchend', stopDrawing);

  document.getElementById('multiStepForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const obj = Object.fromEntries(formData);
    obj.signature = canvas.toDataURL();

    const response = await fetch('https://6e18-47-18-38-63.ngrok-free.app/submit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(obj)
    });

    if (response.ok) {
      alert('Form submitted successfully!');
      e.target.reset();
      clearSignature();
      showStep(0);
    } else {
      alert('Submission failed.');
    }
  });
</script>
</body>
</html>
